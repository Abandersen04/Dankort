<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Dankort</title>

    <!-- Links til nødvendige eksterne biblioteker -->
    <link href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" rel="stylesheet" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <style>
        /* Generelle stilarter */
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        /* Info-boks stil */
        #info-text {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            color: #333;
            z-index: 1000;
            max-width: 250px;
        }

        #info-text p {
            margin: 0 0 5px;
        }

        #info-text p:first-child {
            font-size: 20px;
            font-weight: bold;
        }

        #info-text a {
            color: #007bff;
            text-decoration: none;
        }

        #info-text a:hover {
            text-decoration: underline;
        }

        /* Styling for dropdown og slider */
        #category-filter, #year-slider, #search-input, #born-before, #born-after {
        width: 100%;
        padding: 5px;
        border-radius: 5px;
        font-size: 14px;
        margin-top: 10px;
    }

    #year-slider {
        margin-top: 10px;
    }

    #category-filter {
        margin-bottom: 20px;
    }
</style>
</head>
<body>
    <div id="map"></div> <!-- Kortet -->

    <div id="info-text">
        <p>Dankort</p>
        <p>Placeringerne vises kun på sogne- og områdeniveau.</p>
        <p>Data: <a href="https://www.wikidata.org/wiki/Wikidata:Main_Page" target="_blank">Wikidata</a></p>

        <label for="category-filter">Vælg kategori:</label>
        <select id="category-filter">
            <option value="">Alle</option>

            
            <!-- Kategorien vil blive fyldt dynamisk fra data -->
        </select>

        <label for="year-slider">Født før:</label>
        <input type="range" id="year-slider" min="500" max="2024" value="2024" step="1">
        <span id="year-label">2024</span>

        <!-- Søgefelt for live søgning -->
        <label for="search-input"></label>
        <input type="text" id="search-input" placeholder="Søg efter navn">
    </div>

    <script>
        // Initialiser kortet
        var map = L.map('map').setView([56.2639, 9.5018], 7);  // Sætter kortets initiale visning

        // Tile layer for OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Marker Cluster for effektiv håndtering af markører
        var markers = L.markerClusterGroup({
            maxClusterRadius: 32
        });

        var allData = []; // Her gemmes alle data, som læses fra CSV-filen

        // Indlæs data fra CSV
        Papa.parse("data1.csv", {
    download: true,
    header: true,
    complete: ({ data }) => {
        // Filtrer kun de rækker, der har både valid latitude og longitude
        const validData = data.filter(p => {
            const lat = parseFloat(p.latitude);
            const lon = parseFloat(p.longitude);
            return !isNaN(lat) && !isNaN(lon);  // Kun gyldige numeriske værdier
        });

        if (validData.length === 0) {
            console.error("Der er ingen gyldige data med lat/long.");
        } else {
            allData = validData;
            populateDropdown(validData);
            addMarkers(validData);
        }
    },
    error: e => console.error("Fejl ved indlæsning af CSV:", e)
});









        // Fyld dropdown-menuen med kategorier
        function populateDropdown(data) {
            var categories = [...new Set(data.map(person => person.kategori))]; // Hent unikke kategorier
            var categoryFilter = document.getElementById("category-filter");

            categories.sort().forEach(category => {
                var option = document.createElement("option");
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });
        }

        // Tilføj markører til kortet
        function addMarkers(data) {
            markers.clearLayers(); // Ryd eksisterende markører

            const coordinateCounts = {}; // Tælling af personer pr. koordinat
            data.forEach(person => {
                const key = `${person.latitude},${person.longitude}`;
                coordinateCounts[key] = (coordinateCounts[key] || 0) + 1;
            });

            data.forEach(person => {
                var lat = parseFloat(person.latitude);
                var lng = parseFloat(person.longitude);

                // Jitter-effekt for markørernes placering
                let jitterLat = lat;
                let jitterLng = lng;
                const jitterAmount = 0.035; // Justér jitter-størrelsen
                
                // Hvis der er mere end 10 personer på samme koordinat, anvend større jitter-effekt
                const coordinateKey = `${lat},${lng}`;

                if (coordinateCounts[coordinateKey] > 10) {
                jitterLat += (Math.random() * jitterAmount - jitterAmount / 2);
                jitterLng += (Math.random() * jitterAmount - jitterAmount / 2);
                } else if (coordinateCounts[coordinateKey] > 1) {
    
                // Hvis der er mindre end 10 personer, anvend en lille jitter-effekt
                const smallJitterAmount = 0.01; // Justér denne værdi for at lave en mindre jitter
                jitterLat += (Math.random() * smallJitterAmount - smallJitterAmount / 2);
                jitterLng += (Math.random() * smallJitterAmount - smallJitterAmount / 2);
                 }

                // Opret markør med personens navn som HTML
                var icon = L.divIcon({
                    className: 'person-name',
                    html: "<strong>" + person.personLabel + "</strong>",
                    iconSize: [30, 30],
                    iconAnchor: [15, 15],
                    popupAnchor: [0, -15]
                });

                var marker = L.marker([jitterLat, jitterLng], { icon: icon });
                marker.bindPopup(
                    `<strong>${person.personLabel}</strong><br>` +
                    `Fødested: ${person.birthPlaceLabel || 'Ikke angivet'}<br>` +
                    `Profession: ${person.allProfessions || 'Ikke angivet'}<br>` +
                    `Født: ${person.birthDate || 'Ikke angivet'}<br>` +
                    (person.deathDate && person.deathDate !== 'NA' ? `Død: ${person.deathDate}<br>` : "") +
                    `<a href='${person.wikilink}' target='_blank'>Wikipedia</a>`
                );

                markers.addLayer(marker); // Tilføj markøren til kortet
            });

            map.addLayer(markers); // Tilføj alle markører til kortet
        }

        // Håndter ændringer i dropdown-menuen (kategori-filter)
        document.getElementById("category-filter").addEventListener("change", function() {
            var selectedCategory = this.value;
            var selectedYear = parseInt(document.getElementById("year-slider").value);
            var selectedSearchTerm = document.getElementById("search-input").value.toLowerCase();

            var filteredData = allData.filter(person => {
                var personYear = parseInt(person.year);
                var matchesSearch = person.personLabel.toLowerCase().includes(selectedSearchTerm);
                return (selectedCategory ? person.kategori === selectedCategory : true) &&
                    personYear <= selectedYear && matchesSearch;
            });
            addMarkers(filteredData);
        });

        // Håndter ændringer i slideren (årstal)
        document.getElementById("year-slider").addEventListener("input", function() {
            var selectedYear = this.value;
            document.getElementById("year-label").textContent = selectedYear;

            var selectedCategory = document.getElementById("category-filter").value;
            var selectedSearchTerm = document.getElementById("search-input").value.toLowerCase();

            var filteredData = allData.filter(person => {
                var personYear = parseInt(person.year);
                var matchesSearch = person.personLabel.toLowerCase().includes(selectedSearchTerm);
                return (selectedCategory ? person.kategori === selectedCategory : true) &&
                    personYear <= selectedYear && matchesSearch;
            });
            addMarkers(filteredData);
        });

        // Håndter live-søgning
        document.getElementById("search-input").addEventListener("input", function() {
            var selectedSearchTerm = this.value.toLowerCase();
            var selectedYear = parseInt(document.getElementById("year-slider").value);
            var selectedCategory = document.getElementById("category-filter").value;

            var filteredData = allData.filter(person => {
                var personYear = parseInt(person.year);
                var matchesSearch = person.personLabel.toLowerCase().includes(selectedSearchTerm);
                return (selectedCategory ? person.kategori === selectedCategory : true) &&
                    personYear <= selectedYear && matchesSearch;
            });
            addMarkers(filteredData);
        });
    </script>
</body>
</html>
